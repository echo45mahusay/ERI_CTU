<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERI - Enhanced Multi-Node Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-yellow: #fbbf24;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --border-color: #2d3748;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        
        /* Top Navigation */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 0;
        }
        
        .nav-logo {
            width: 24px;
            height: 24px;
            background: var(--accent-cyan);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        
        .nav-title {
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0;
        }
        
        .nav-tab {
            padding: 1.5rem 2rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-tab:hover { color: var(--text-primary); background: rgba(6, 182, 212, 0.05); }
        .nav-tab.active { color: var(--text-primary); border-bottom-color: var(--accent-cyan); background: rgba(6, 182, 212, 0.05); }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent-cyan);
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .btn:hover { background: #0891b2; transform: translateY(-2px); }
        .btn-success { background: var(--accent-green); }
        .btn-success:hover { background: #059669; }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border-color); }
        
        /* Main Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Threshold Configuration Card */
        .config-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .config-title {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .config-item {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
        }
        
        .config-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .config-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
        
        .config-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }
        
        .config-help {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        /* Overall Status Card */
        .overall-status {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .overall-status-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
        }
        
        .overall-status-value {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .overall-status-value.safe { color: var(--accent-green); }
        .overall-status-value.unsafe { color: var(--accent-red); animation: pulse-red 1s infinite; }
        
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .overall-status-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* Node Grid */
        .nodes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .node-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .node-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .node-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .node-status.online {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
        }
        
        .node-status.offline {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
        }
        
        .node-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .node-stat {
            text-align: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        
        .node-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .node-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .chart-wrapper {
            height: 250px;
            margin-bottom: 1rem;
        }
        
        /* History Tab */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .history-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .history-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .history-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 1rem;
        }
        
        .history-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-red);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            border-left-width: 6px;
            transform: translateX(4px);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .history-timestamp {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .history-badge {
            padding: 0.25rem 0.75rem;
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .history-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .history-detail {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 6px;
        }
        
        .history-detail-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .history-detail-value {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .history-data-buffer {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .history-data-title {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }
        
        .history-data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .history-data-chart {
            height: 150px;
        }
        
        /* Scrollbar Styling */
        .history-list::-webkit-scrollbar {
            width: 10px;
        }
        
        .history-list::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 5px;
        }
        
        .history-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }
        
        .history-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 0.75rem 2rem;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .status-left {
            display: flex;
            gap: 2rem;
            color: var(--text-muted);
        }
        
        .status-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .online-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-green);
        }
        
        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .nodes-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .nav-tabs {
                display: none;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="nav-logo"></div>
                <span class="nav-title">ERI - Multi-Node Monitoring</span>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('monitoring')">üìä Live Monitoring</button>
                <button class="nav-tab" onclick="switchTab('history')">üìú Unsafe Events History</button>
            </div>
            
            <div class="nav-right">
                <button class="btn btn-success" id="connectBtn" onclick="connectMQTT()">üîå Connect</button>
            </div>
        </div>
    </nav>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Monitoring Tab -->
        <div id="monitoringTab" class="tab-content active">
            <!-- Threshold Configuration -->
            <div class="config-card">
                <div class="config-header">
                    <div class="config-title">
                        <span>‚öôÔ∏è</span>
                        <span>Threshold Configuration</span>
                    </div>
                    <button class="btn" onclick="applyThreshold()">Apply Threshold</button>
                </div>
                <div class="config-grid">
                    <div class="config-item">
                        <label class="config-label">Unsafe Threshold (m/s¬≤)</label>
                        <input type="number" class="config-input" id="thresholdUnsafe" value="11.5" step="0.1" min="9.0" max="20.0">
                        <p class="config-help">Magnitude above this value triggers UNSAFE status</p>
                    </div>
                    <div class="config-item">
                        <label class="config-label">Structure Name</label>
                        <input type="text" class="config-input" id="structureName" value="CTU Main Building" placeholder="Building Name">
                        <p class="config-help">Identify the structure being monitored</p>
                    </div>
                    <div class="config-item">
                        <label class="config-label">Buffer Duration (seconds)</label>
                        <input type="number" class="config-input" id="bufferDuration" value="5" step="1" min="3" max="10">
                        <p class="config-help">Record data ¬±N seconds around unsafe events</p>
                    </div>
                </div>
            </div>
            
            <!-- Overall Structure Status -->
            <div class="overall-status" id="overallStatus">
                <div class="overall-status-label">OVERALL STRUCTURE STATUS</div>
                <div class="overall-status-value safe" id="overallStatusValue">SAFE</div>
                <div class="overall-status-info" id="overallStatusInfo">All nodes operating within safe parameters</div>
            </div>
            
            <!-- Both Nodes Side by Side -->
            <div class="nodes-grid">
                <!-- Node 1 - Ground Floor -->
                <div class="node-card">
                    <div class="node-header">
                        <div>
                            <div class="node-title">üè¢ Ground Floor</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">CTU Main Building - Ground Level</div>
                        </div>
                        <div class="node-status offline" id="node1Status">Offline</div>
                    </div>
                    <div class="node-stats">
                        <div class="node-stat">
                            <div class="node-stat-label">Current</div>
                            <div class="node-stat-value" id="node1Current">0.0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">m/s¬≤</div>
                        </div>
                        <div class="node-stat">
                            <div class="node-stat-label">Max</div>
                            <div class="node-stat-value" id="node1Max">0.0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">m/s¬≤</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="node1Chart"></canvas>
                    </div>
                </div>
                
                <!-- Node 2 - Top Floor -->
                <div class="node-card">
                    <div class="node-header">
                        <div>
                            <div class="node-title">üèóÔ∏è Top Floor</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">CTU Main Building - Top Level</div>
                        </div>
                        <div class="node-status offline" id="node2Status">Offline</div>
                    </div>
                    <div class="node-stats">
                        <div class="node-stat">
                            <div class="node-stat-label">Current</div>
                            <div class="node-stat-value" id="node2Current">0.0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">m/s¬≤</div>
                        </div>
                        <div class="node-stat">
                            <div class="node-stat-label">Max</div>
                            <div class="node-stat-value" id="node2Max">0.0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">m/s¬≤</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="node2Chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="historyTab" class="tab-content">
            <div class="history-header">
                <div class="history-title">‚ö†Ô∏è Unsafe Events History</div>
                <div class="history-stats">
                    <span>Total Events: <strong id="historyCount">0</strong></span>
                    <span>Last Event: <strong id="lastEventTime">Never</strong></span>
                </div>
            </div>
            <div class="history-list" id="historyList">
                <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                    <div>No unsafe events recorded yet</div>
                    <div style="font-size: 0.875rem; margin-top: 0.5rem;">Events will appear here when threshold is exceeded</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <span id="statusInfo">Waiting for connection...</span>
        </div>
        <div class="status-right">
            <div class="online-indicator">
                <div class="online-dot"></div>
                <span id="onlineStatus">Offline</span>
            </div>
            <span style="color: var(--text-muted)">Last: <span id="lastUpdate">--:--:--</span></span>
        </div>
    </div>
    
    <script>
        // MQTT Configuration
        const MQTT_BROKER = 'df7f72e09ae84a60aa37e2f4e19c7356.s1.eu.hivemq.cloud';
        const MQTT_PORT = 8884;
        const MQTT_USERNAME = 'ERI-Cluster';
        const MQTT_PASSWORD = 'Abc12345';
        
        let client = null;
        let THRESHOLD_UNSAFE = 11.5;
        let BUFFER_DURATION = 5;
        let MAX_POINTS = 50;
        
        // Node data structures
        const nodes = {
            node1: {
                id: 'node1',
                name: 'Ground Floor',
                online: false,
                currentMagnitude: 0,
                maxMagnitude: 0,
                data: [],
                chartData: { labels: [], magnitude: [] },
                dataBuffer: [] // Rolling buffer for history
            },
            node2: {
                id: 'node2',
                name: 'Top Floor',
                online: false,
                currentMagnitude: 0,
                maxMagnitude: 0,
                data: [],
                chartData: { labels: [], magnitude: [] },
                dataBuffer: []
            }
        };
        
        let structureStatus = 'SAFE';
        let unsafeEvents = [];
        let isRecordingEvent = false;
        let eventStartTime = null;
        
        // Initialize Charts
        const chartColors = {
            cyan: '#06b6d4',
            purple: '#a855f7',
            green: '#10b981',
            yellow: '#fbbf24',
            red: '#ef4444'
        };
        
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: {
                    ticks: { color: '#9ca3af', maxTicksLimit: 8 },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                },
                y: {
                    ticks: { color: '#9ca3af' },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    title: { display: true, text: 'Magnitude (m/s¬≤)', color: '#9ca3af' }
                }
            },
            animation: false
        };
        
        const node1Chart = new Chart(document.getElementById('node1Chart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Ground Floor',
                    data: [],
                    borderColor: chartColors.cyan,
                    backgroundColor: chartColors.cyan + '33',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: commonOptions
        });
        
        const node2Chart = new Chart(document.getElementById('node2Chart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Top Floor',
                    data: [],
                    borderColor: chartColors.purple,
                    backgroundColor: chartColors.purple + '33',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: commonOptions
        });
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'monitoring') {
                document.querySelector('.nav-tab:nth-child(1)').classList.add('active');
                document.getElementById('monitoringTab').classList.add('active');
            } else if (tabName === 'history') {
                document.querySelector('.nav-tab:nth-child(2)').classList.add('active');
                document.getElementById('historyTab').classList.add('active');
            }
        }
        
        // Apply threshold configuration
        function applyThreshold() {
            THRESHOLD_UNSAFE = parseFloat(document.getElementById('thresholdUnsafe').value);
            BUFFER_DURATION = parseInt(document.getElementById('bufferDuration').value);
            
            alert(`‚úì Configuration Applied\n\nUnsafe Threshold: ${THRESHOLD_UNSAFE} m/s¬≤\nBuffer Duration: ¬±${BUFFER_DURATION} seconds`);
        }
        
        // MQTT Functions
        function connectMQTT() {
            const clientId = 'ERI_Enhanced_' + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, '/mqtt', clientId);
            
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            
            client.connect({
                userName: MQTT_USERNAME,
                password: MQTT_PASSWORD,
                onSuccess: onConnect,
                onFailure: onFailure,
                useSSL: true
            });
            
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectBtn').textContent = '‚è≥ Connecting...';
        }
        
        function onConnect() {
            console.log('Connected to HiveMQ Cloud');
            document.getElementById('connectBtn').textContent = '‚úì Connected';
            document.getElementById('connectBtn').classList.remove('btn-success');
            document.getElementById('onlineStatus').textContent = 'Online';
            
            // Subscribe to all node topics
            client.subscribe('eri/earthquake/+/acceleration');
            client.subscribe('eri/earthquake/+/status');
            
            document.getElementById('statusInfo').textContent = 'Connected to MQTT broker, waiting for data...';
        }
        
        function onFailure(error) {
            console.error('Connection failed:', error);
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('connectBtn').textContent = 'üîå Reconnect';
        }
        
        function onConnectionLost(responseObject) {
            console.log('Connection lost:', responseObject.errorMessage);
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('connectBtn').textContent = 'üîå Reconnect';
            document.getElementById('connectBtn').classList.add('btn-success');
            document.getElementById('onlineStatus').textContent = 'Disconnected';
        }
        
        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = JSON.parse(message.payloadString);
            const parts = topic.split('/');
            const nodeId = parts[2];
            const type = parts[3];
            
            if (type === 'acceleration') {
                updateAccelerationData(nodeId, payload);
            } else if (type === 'status' && payload.status === 'online') {
                nodes[nodeId].online = true;
                updateNodeStatus(nodeId);
            }
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        function updateNodeStatus(nodeId) {
            const statusEl = document.getElementById(`${nodeId}Status`);
            statusEl.textContent = 'Online';
            statusEl.classList.remove('offline');
            statusEl.classList.add('online');
        }
        
        function updateAccelerationData(nodeId, data) {
            const node = nodes[nodeId];
            const { x, y, z, magnitude } = data;
            const timestamp = new Date().toLocaleTimeString();
            const fullTimestamp = new Date();
            
            // Update node data
            node.currentMagnitude = magnitude;
            if (magnitude > node.maxMagnitude) node.maxMagnitude = magnitude;
            
            // Add to rolling buffer (for history capture)
            node.dataBuffer.push({
                timestamp: fullTimestamp,
                magnitude: magnitude,
                x: x,
                y: y,
                z: z
            });
            
            // Keep buffer at reasonable size (2 minutes of data at 1Hz)
            if (node.dataBuffer.length > 120) {
                node.dataBuffer.shift();
            }
            
            // Add to chart data
            node.chartData.labels.push(timestamp);
            node.chartData.magnitude.push(magnitude);
            
            // Keep last MAX_POINTS
            if (node.chartData.labels.length > MAX_POINTS) {
                node.chartData.labels.shift();
                node.chartData.magnitude.shift();
            }
            
            // Update UI
            document.getElementById(`${nodeId}Current`).textContent = magnitude.toFixed(2);
            document.getElementById(`${nodeId}Max`).textContent = node.maxMagnitude.toFixed(2);
            
            // Update chart
            const chart = nodeId === 'node1' ? node1Chart : node2Chart;
            chart.data.labels = [...node.chartData.labels];
            chart.data.datasets[0].data = [...node.chartData.magnitude];
            chart.update('none');
            
            // Check overall structure status
            checkStructureStatus();
        }
        
        function checkStructureStatus() {
            const node1Mag = nodes.node1.currentMagnitude;
            const node2Mag = nodes.node2.currentMagnitude;
            const maxMag = Math.max(node1Mag, node2Mag);
            
            const statusEl = document.getElementById('overallStatusValue');
            const infoEl = document.getElementById('overallStatusInfo');
            
            if (maxMag >= THRESHOLD_UNSAFE) {
                if (structureStatus === 'SAFE') {
                    // Just became unsafe - start recording event
                    structureStatus = 'UNSAFE';
                    startUnsafeEvent();
                }
                
                statusEl.textContent = 'UNSAFE';
                statusEl.className = 'overall-status-value unsafe';
                infoEl.textContent = `‚ö†Ô∏è Threshold exceeded! Max magnitude: ${maxMag.toFixed(2)} m/s¬≤ (Threshold: ${THRESHOLD_UNSAFE} m/s¬≤)`;
                
                document.getElementById('statusInfo').textContent = `‚ö†Ô∏è UNSAFE CONDITION - Recording event data...`;
            } else {
                if (structureStatus === 'UNSAFE') {
                    // Just became safe - end recording event
                    endUnsafeEvent();
                }
                
                structureStatus = 'SAFE';
                statusEl.textContent = 'SAFE';
                statusEl.className = 'overall-status-value safe';
                infoEl.textContent = `All nodes operating within safe parameters (Current max: ${maxMag.toFixed(2)} m/s¬≤)`;
                
                document.getElementById('statusInfo').textContent = `Monitoring ${nodes.node1.online && nodes.node2.online ? 'both nodes' : 'nodes'} | Threshold: ${THRESHOLD_UNSAFE} m/s¬≤`;
            }
        }
        
        function startUnsafeEvent() {
            isRecordingEvent = true;
            eventStartTime = new Date();
            console.log('Started recording unsafe event');
        }
        
        function endUnsafeEvent() {
            if (!isRecordingEvent) return;
            
            isRecordingEvent = false;
            const eventEndTime = new Date();
            
            // Collect data from BUFFER_DURATION seconds before and after
            const bufferMs = BUFFER_DURATION * 1000;
            const captureStartTime = new Date(eventStartTime.getTime() - bufferMs);
            const captureEndTime = new Date(eventEndTime.getTime() + bufferMs);
            
            // Extract buffered data for both nodes
            const node1Data = nodes.node1.dataBuffer.filter(d => 
                d.timestamp >= captureStartTime && d.timestamp <= captureEndTime
            );
            const node2Data = nodes.node2.dataBuffer.filter(d => 
                d.timestamp >= captureStartTime && d.timestamp <= captureEndTime
            );
            
            // Create event record
            const event = {
                id: unsafeEvents.length + 1,
                timestamp: eventStartTime,
                endTime: eventEndTime,
                duration: (eventEndTime - eventStartTime) / 1000,
                maxMagnitude: Math.max(nodes.node1.maxMagnitude, nodes.node2.maxMagnitude),
                node1Data: node1Data,
                node2Data: node2Data,
                structureName: document.getElementById('structureName').value
            };
            
            unsafeEvents.unshift(event); // Add to beginning
            
            // Update history UI
            updateHistoryUI();
            
            console.log('Ended recording unsafe event', event);
        }
        
        function updateHistoryUI() {
            document.getElementById('historyCount').textContent = unsafeEvents.length;
            
            if (unsafeEvents.length > 0) {
                document.getElementById('lastEventTime').textContent = unsafeEvents[0].timestamp.toLocaleString();
                
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                unsafeEvents.forEach(event => {
                    const eventHtml = `
                        <div class="history-item">
                            <div class="history-item-header">
                                <div class="history-timestamp">${event.timestamp.toLocaleString()}</div>
                                <div class="history-badge">UNSAFE EVENT #${event.id}</div>
                            </div>
                            <div class="history-details">
                                <div class="history-detail">
                                    <div class="history-detail-label">Duration</div>
                                    <div class="history-detail-value">${event.duration.toFixed(1)}s</div>
                                </div>
                                <div class="history-detail">
                                    <div class="history-detail-label">Max Magnitude</div>
                                    <div class="history-detail-value">${event.maxMagnitude.toFixed(2)} m/s¬≤</div>
                                </div>
                                <div class="history-detail">
                                    <div class="history-detail-label">Structure</div>
                                    <div class="history-detail-value">${event.structureName}</div>
                                </div>
                                <div class="history-detail">
                                    <div class="history-detail-label">Data Points</div>
                                    <div class="history-detail-value">${event.node1Data.length + event.node2Data.length}</div>
                                </div>
                            </div>
                            <div class="history-data-buffer">
                                <div class="history-data-title">üìä Recorded Data (¬±${BUFFER_DURATION}s buffer)</div>
                                <div class="history-data-grid">
                                    <div>
                                        <strong>Ground Floor:</strong> ${event.node1Data.length} samples
                                        <br>Range: ${Math.min(...event.node1Data.map(d => d.magnitude)).toFixed(2)} - ${Math.max(...event.node1Data.map(d => d.magnitude)).toFixed(2)} m/s¬≤
                                    </div>
                                    <div>
                                        <strong>Top Floor:</strong> ${event.node2Data.length} samples
                                        <br>Range: ${Math.min(...event.node2Data.map(d => d.magnitude)).toFixed(2)} - ${Math.max(...event.node2Data.map(d => d.magnitude)).toFixed(2)} m/s¬≤
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    historyList.innerHTML += eventHtml;
                });
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            console.log('ERI Enhanced Dashboard loaded');
        });
    </script>
</body>
</html>
