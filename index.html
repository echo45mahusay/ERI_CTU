<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERI - Multi-Node Earthquake Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-yellow: #fbbf24;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --border-color: #2d3748;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        
        /* Top Navigation */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 0;
        }
        
        .nav-logo {
            width: 24px;
            height: 24px;
            background: var(--accent-cyan);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        
        .nav-title {
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent-cyan);
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .btn:hover { background: #0891b2; transform: translateY(-2px); }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--bg-secondary); border-color: var(--accent-cyan); }
        .btn-success { background: var(--accent-green); }
        .btn-success:hover { background: #059669; }
        
        /* Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Page Header */
        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .page-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        /* Node Selector */
        .node-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .node-tab {
            padding: 1rem 2rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }
        
        .node-tab:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }
        
        .node-tab.active {
            border-color: var(--accent-cyan);
            background: rgba(6, 182, 212, 0.1);
        }
        
        .node-tab.node1.active { border-color: var(--accent-cyan); }
        .node-tab.node2.active { border-color: var(--accent-purple); }
        
        .node-tab-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .node-tab-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .node-tab-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .node-tab-status.online {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }
        
        .node-tab-status.offline {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .stat-icon.cyan { background: rgba(6, 182, 212, 0.1); color: var(--accent-cyan); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--accent-green); }
        .stat-icon.yellow { background: rgba(251, 191, 36, 0.1); color: var(--accent-yellow); }
        .stat-icon.red { background: rgba(239, 68, 68, 0.1); color: var(--accent-red); }
        .stat-icon.purple { background: rgba(168, 85, 247, 0.1); color: var(--accent-purple); }
        
        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .stat-unit {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        /* Threshold Badge */
        .threshold-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .threshold-safe {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }
        
        .threshold-warning {
            background: rgba(251, 191, 36, 0.2);
            color: var(--accent-yellow);
        }
        
        .threshold-unsafe {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }
        
        /* Chart Card */
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chart-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .chart-canvas {
            width: 100% !important;
            height: 300px !important;
        }
        
        /* Comparison View */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Alert Banner */
        .alert-banner {
            background: var(--bg-card);
            border: 2px solid var(--accent-red);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: none;
        }
        
        .alert-banner.active {
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { border-color: var(--accent-red); }
            50% { border-color: var(--accent-yellow); }
        }
        
        .alert-icon { font-size: 2rem; }
        
        .alert-content h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        
        .alert-content p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        /* Event Log */
        .event-log {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .log-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .log-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .log-table thead {
            background: var(--bg-secondary);
        }
        
        .log-table th {
            padding: 1rem;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        .log-table td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
        }
        
        .mag-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: rgba(6, 182, 212, 0.2);
            color: var(--accent-cyan);
            border-radius: 4px;
            font-weight: 600;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-badge.status-safe {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }
        
        .status-badge.status-warning {
            background: rgba(251, 191, 36, 0.2);
            color: var(--accent-yellow);
        }
        
        .status-badge.status-unsafe {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .node-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .node-badge.node1 {
            background: rgba(6, 182, 212, 0.2);
            color: var(--accent-cyan);
        }
        
        .node-badge.node2 {
            background: rgba(168, 85, 247, 0.2);
            color: var(--accent-purple);
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="nav-logo"></div>
                <span class="nav-title">ERI - Multi-Node Earthquake Monitoring System</span>
            </div>
            <div class="nav-right">
                <button class="btn btn-secondary" onclick="exportToCSV()">üìä Export CSV</button>
                <button class="btn btn-success" id="connectBtn" onclick="connectMQTT()">üîå Connect</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Alert Banner -->
        <div class="alert-banner" id="alertBanner">
            <div class="alert-icon">üö®</div>
            <div class="alert-content">
                <h3>EARTHQUAKE DETECTED!</h3>
                <p id="alertMessage">STA/LTA threshold exceeded</p>
            </div>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1 class="page-title">Real-Time Seismic Monitoring</h1>
                <p class="page-subtitle">Multi-node earthquake detection ‚Ä¢ Last update: <span id="lastUpdate">--:--:--</span></p>
            </div>
        </div>
        
        <!-- Node Selector -->
        <div class="node-selector">
            <div class="node-tab node1 active" onclick="switchNode('node1')">
                <div class="node-tab-title">üè¢ Ground Floor</div>
                <div class="node-tab-subtitle">CTU Main Building - Ground Level</div>
                <div class="node-tab-status offline" id="node1Status">Offline</div>
            </div>
            <div class="node-tab node2" onclick="switchNode('node2')">
                <div class="node-tab-title">üèóÔ∏è Top Floor</div>
                <div class="node-tab-subtitle">CTU Main Building - Top Level</div>
                <div class="node-tab-status offline" id="node2Status">Offline</div>
            </div>
            <div class="node-tab" onclick="switchNode('comparison')">
                <div class="node-tab-title">üìä Comparison View</div>
                <div class="node-tab-subtitle">Compare Both Nodes</div>
                <div class="node-tab-status online">Active</div>
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be dynamically populated -->
        </div>
        
        <!-- Charts Section -->
        <div id="chartsSection">
            <!-- Charts will be dynamically populated based on view -->
        </div>
        
        <!-- Event Log -->
        <div class="event-log">
            <div class="log-header">
                <div class="chart-title">Recent Seismic Events</div>
                <div class="chart-subtitle" id="statusInfo">0 Events today | Max 0.0 m/s¬≤</div>
            </div>
            <table class="log-table">
                <thead>
                    <tr>
                        <th>Node</th>
                        <th>Magnitude</th>
                        <th>Time</th>
                        <th>Location</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="eventTableBody">
                    <!-- Events will be added dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // MQTT Configuration
        const MQTT_BROKER = 'df7f72e09ae84a60aa37e2f4e19c7356.s1.eu.hivemq.cloud';
        const MQTT_PORT = 8884;
        const MQTT_USERNAME = 'ERI-Cluster';
        const MQTT_PASSWORD = 'Abc12345';
        
        // Safety Thresholds
        const THRESHOLD_SAFE = 10.5;
        const THRESHOLD_WARNING = 11.5;
        
        // Global State
        let client;
        let currentView = 'node1';
        let eventCount = 0;
        
        // Node Data Storage
        const nodes = {
            node1: {
                id: 'node1',
                name: 'Ground Floor',
                location: 'CTU Main Building - Ground Level',
                online: false,
                data: [],
                currentMagnitude: 0,
                maxMagnitude: 0,
                stalta: 0,
                earthquakeDetected: false,
                dataPoints: 0,
                totalSum: 0
            },
            node2: {
                id: 'node2',
                name: 'Top Floor',
                location: 'CTU Main Building - Top Level',
                online: false,
                data: [],
                currentMagnitude: 0,
                maxMagnitude: 0,
                stalta: 0,
                earthquakeDetected: false,
                dataPoints: 0,
                totalSum: 0
            }
        };
        
        // CSV Data Storage
        let csvData = [];
        
        // Chart Colors
        const chartColors = {
            cyan: '#06b6d4',
            purple: '#a855f7',
            green: '#10b981',
            yellow: '#fbbf24',
            red: '#ef4444',
            text: '#9ca3af'
        };
        
        // Charts
        let charts = {
            node1: {},
            node2: {},
            comparison: {}
        };
        
        // Common Chart Options
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: chartColors.text,
                        font: { family: 'JetBrains Mono' }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: chartColors.text, maxTicksLimit: 10 },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                },
                y: {
                    ticks: { color: chartColors.text },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    beginAtZero: false
                }
            },
            animation: false
        };
        
        // Initialize
        function init() {
            switchNode('node1');
            setTimeout(connectMQTT, 500);
        }
        
        // MQTT Functions
        function connectMQTT() {
            const clientId = 'ERI_MultiNode_' + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, '/mqtt', clientId);
            
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            
            client.connect({
                userName: MQTT_USERNAME,
                password: MQTT_PASSWORD,
                onSuccess: onConnect,
                onFailure: onFailure,
                useSSL: true
            });
            
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectBtn').textContent = '‚è≥ Connecting...';
        }
        
        function onConnect() {
            console.log('Connected to HiveMQ Cloud');
            document.getElementById('connectBtn').textContent = '‚úì Connected';
            document.getElementById('connectBtn').classList.remove('btn-success');
            document.getElementById('connectBtn').classList.add('btn-secondary');
            
            // Subscribe to all node topics
            client.subscribe('eri/earthquake/+/acceleration');
            client.subscribe('eri/earthquake/+/stalta');
            client.subscribe('eri/earthquake/+/alert');
            client.subscribe('eri/earthquake/+/status');
        }
        
        function onFailure(error) {
            console.error('Connection failed:', error);
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('connectBtn').textContent = 'üîå Connect';
        }
        
        function onConnectionLost(responseObject) {
            console.log('Connection lost:', responseObject.errorMessage);
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('connectBtn').textContent = 'üîå Reconnect';
            document.getElementById('connectBtn').classList.add('btn-success');
            document.getElementById('connectBtn').classList.remove('btn-secondary');
        }
        
        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = JSON.parse(message.payloadString);
            const parts = topic.split('/');
            const nodeId = parts[2]; // eri/earthquake/[nodeId]/[type]
            const type = parts[3];
            
            if (type === 'acceleration') {
                updateAccelerationData(nodeId, payload);
            } else if (type === 'stalta') {
                updateSTALTAData(nodeId, payload);
            } else if (type === 'alert') {
                handleAlert(nodeId, payload);
            } else if (type === 'status' && payload.status === 'online') {
                nodes[nodeId].online = true;
                updateNodeStatus(nodeId);
            }
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        function updateNodeStatus(nodeId) {
            const statusEl = document.getElementById(`${nodeId}Status`);
            if (nodes[nodeId].online) {
                statusEl.textContent = 'Online';
                statusEl.classList.remove('offline');
                statusEl.classList.add('online');
            }
        }
        
        function updateAccelerationData(nodeId, data) {
            const node = nodes[nodeId];
            const { x, y, z, magnitude } = data;
            const timestamp = new Date().toLocaleTimeString();
            
            node.currentMagnitude = magnitude;
            node.dataPoints++;
            node.totalSum += magnitude;
            if (magnitude > node.maxMagnitude) node.maxMagnitude = magnitude;
            
            // Store data
            node.data.push({
                timestamp: new Date().toISOString(),
                x, y, z, magnitude,
                stalta: node.stalta,
                status: getStatusText(magnitude)
            });
            
            // Keep last 1000 points
            if (node.data.length > 1000) node.data.shift();
            
            // Update charts if viewing this node
            if (currentView === nodeId || currentView === 'comparison') {
                updateCharts();
            }
            
            // Update stats
            updateStats();
            
            // Add to event log occasionally
            eventCount++;
            if (eventCount % 5 === 0) {
                addEventToLog(nodeId, magnitude, timestamp);
            }
        }
        
        function updateSTALTAData(nodeId, data) {
            const node = nodes[nodeId];
            node.stalta = data.ratio;
            node.earthquakeDetected = data.earthquakeDetected;
            
            if (data.earthquakeDetected) {
                showAlert(nodeId);
            }
            
            updateStats();
            if (currentView === nodeId || currentView === 'comparison') {
                updateCharts();
            }
        }
        
        function handleAlert(nodeId, data) {
            console.log('EARTHQUAKE ALERT from', nodeId, data);
        }
        
        function showAlert(nodeId) {
            const node = nodes[nodeId];
            document.getElementById('alertBanner').classList.add('active');
            document.getElementById('alertMessage').textContent = 
                `${node.name}: STA/LTA Ratio ${node.stalta.toFixed(3)} | Magnitude ${node.currentMagnitude.toFixed(2)} m/s¬≤`;
        }
        
        function getStatusText(magnitude) {
            if (magnitude > THRESHOLD_WARNING) return 'UNSAFE';
            if (magnitude > THRESHOLD_SAFE) return 'WARNING';
            return 'SAFE';
        }
        
        function switchNode(view) {
            currentView = view;
            
            // Update tabs
            document.querySelectorAll('.node-tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.node-tab').classList.add('active');
            
            // Rebuild view
            if (view === 'comparison') {
                buildComparisonView();
            } else {
                buildSingleNodeView(view);
            }
            
            updateStats();
            updateCharts();
        }
        
        function buildSingleNodeView(nodeId) {
            const node = nodes[nodeId];
            const color = nodeId === 'node1' ? chartColors.cyan : chartColors.purple;
            
            // Build stats
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon green">üõ°Ô∏è</div>
                        <span class="stat-label">Status</span>
                    </div>
                    <div class="stat-value" id="${nodeId}StatusValue">SAFE</div>
                    <div class="threshold-badge threshold-safe" id="${nodeId}ThresholdBadge">Below Threshold</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon cyan">üìä</div>
                    <span class="stat-label">Current Magnitude</span>
                    <div class="stat-value" id="${nodeId}CurrentMag">0.0</div>
                    <span class="stat-unit">m/s¬≤</span>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon red">‚ö†Ô∏è</div>
                    <span class="stat-label">Max Magnitude</span>
                    <div class="stat-value" id="${nodeId}MaxMag">0.0</div>
                    <span class="stat-unit">m/s¬≤</span>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon yellow">üìà</div>
                    <span class="stat-label">STA/LTA Ratio</span>
                    <div class="stat-value" id="${nodeId}STALTAValue">0.00</div>
                    <span class="stat-unit">Threshold: 3.0</span>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon green">üì°</div>
                    <span class="stat-label">Connection</span>
                    <div class="stat-value" id="${nodeId}Connection" style="font-size: 1.5rem;">${node.online ? 'Online' : 'Offline'}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon ${nodeId === 'node1' ? 'cyan' : 'purple'}">üî¢</div>
                    <span class="stat-label">Data Points</span>
                    <div class="stat-value" id="${nodeId}DataPoints">0</div>
                    <span class="stat-unit">recorded</span>
                </div>
            `;
            
            // Build charts
            document.getElementById('chartsSection').innerHTML = `
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">STA/LTA Earthquake Detection</div>
                            <div class="chart-subtitle">${node.name}</div>
                        </div>
                    </div>
                    <canvas id="${nodeId}STALTAChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">3-Axis Acceleration</div>
                            <div class="chart-subtitle">${node.name}</div>
                        </div>
                    </div>
                    <canvas id="${nodeId}AccelChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Magnitude Over Time</div>
                            <div class="chart-subtitle">${node.name}</div>
                        </div>
                    </div>
                    <canvas id="${nodeId}MagChart" class="chart-canvas"></canvas>
                </div>
            `;
            
            // Initialize charts
            setTimeout(() => {
                charts[nodeId].stalta = new Chart(document.getElementById(`${nodeId}STALTAChart`), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'STA/LTA Ratio',
                                data: [],
                                borderColor: color,
                                backgroundColor: color + '33',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Threshold',
                                data: [],
                                borderColor: chartColors.red,
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false
                            }
                        ]
                    },
                    options: commonOptions
                });
                
                charts[nodeId].accel = new Chart(document.getElementById(`${nodeId}AccelChart`), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'X', data: [], borderColor: chartColors.red, borderWidth: 2, fill: false },
                            { label: 'Y', data: [], borderColor: chartColors.green, borderWidth: 2, fill: false },
                            { label: 'Z', data: [], borderColor: color, borderWidth: 2, fill: false }
                        ]
                    },
                    options: commonOptions
                });
                
                charts[nodeId].magnitude = new Chart(document.getElementById(`${nodeId}MagChart`), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Magnitude',
                            data: [],
                            borderColor: color,
                            backgroundColor: color + '33',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: commonOptions
                });
            }, 100);
        }
        
        function buildComparisonView() {
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon cyan">üè¢</div>
                    <span class="stat-label">Ground Floor</span>
                    <div class="stat-value" id="node1CompMag">0.0</div>
                    <span class="stat-unit">m/s¬≤</span>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon purple">üèóÔ∏è</div>
                    <span class="stat-label">Top Floor</span>
                    <div class="stat-value" id="node2CompMag">0.0</div>
                    <span class="stat-unit">m/s¬≤</span>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon yellow">üìä</div>
                    <span class="stat-label">Amplification Factor</span>
                    <div class="stat-value" id="ampFactor">1.0x</div>
                    <span class="stat-unit">Top / Ground</span>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon green">‚úì</div>
                    <span class="stat-label">Both Nodes</span>
                    <div class="stat-value" style="font-size: 1.5rem;" id="bothOnline">Checking...</div>
                </div>
            `;
            
            document.getElementById('chartsSection').innerHTML = `
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Magnitude Comparison</div>
                            <div class="chart-subtitle">Ground Floor vs Top Floor</div>
                        </div>
                    </div>
                    <canvas id="compMagChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="comparison-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">Ground Floor STA/LTA</div>
                            </div>
                        </div>
                        <canvas id="compNode1STALTA" class="chart-canvas"></canvas>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <div>
                                <div class="chart-title">Top Floor STA/LTA</div>
                            </div>
                        </div>
                        <canvas id="compNode2STALTA" class="chart-canvas"></canvas>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                charts.comparison.magnitude = new Chart(document.getElementById('compMagChart'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Ground Floor',
                                data: [],
                                borderColor: chartColors.cyan,
                                borderWidth: 2,
                                fill: false
                            },
                            {
                                label: 'Top Floor',
                                data: [],
                                borderColor: chartColors.purple,
                                borderWidth: 2,
                                fill: false
                            }
                        ]
                    },
                    options: commonOptions
                });
                
                charts.comparison.node1stalta = new Chart(document.getElementById('compNode1STALTA'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'STA/LTA',
                            data: [],
                            borderColor: chartColors.cyan,
                            borderWidth: 2,
                            fill: true,
                            backgroundColor: chartColors.cyan + '33'
                        }]
                    },
                    options: commonOptions
                });
                
                charts.comparison.node2stalta = new Chart(document.getElementById('compNode2STALTA'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'STA/LTA',
                            data: [],
                            borderColor: chartColors.purple,
                            borderWidth: 2,
                            fill: true,
                            backgroundColor: chartColors.purple + '33'
                        }]
                    },
                    options: commonOptions
                });
            }, 100);
        }
        
        function updateStats() {
            if (currentView === 'comparison') {
                document.getElementById('node1CompMag').textContent = nodes.node1.currentMagnitude.toFixed(2);
                document.getElementById('node2CompMag').textContent = nodes.node2.currentMagnitude.toFixed(2);
                
                const amp = nodes.node1.currentMagnitude > 0 ? 
                    (nodes.node2.currentMagnitude / nodes.node1.currentMagnitude) : 1.0;
                document.getElementById('ampFactor').textContent = amp.toFixed(2) + 'x';
                
                const bothOnline = nodes.node1.online && nodes.node2.online;
                document.getElementById('bothOnline').textContent = bothOnline ? 'Online' : 'Checking...';
            } else {
                const node = nodes[currentView];
                const nodeId = currentView;
                
                document.getElementById(`${nodeId}CurrentMag`).textContent = node.currentMagnitude.toFixed(2);
                document.getElementById(`${nodeId}MaxMag`).textContent = node.maxMagnitude.toFixed(2);
                document.getElementById(`${nodeId}STALTAValue`).textContent = node.stalta.toFixed(3);
                document.getElementById(`${nodeId}DataPoints`).textContent = node.dataPoints;
                
                const statusEl = document.getElementById(`${nodeId}StatusValue`);
                const badgeEl = document.getElementById(`${nodeId}ThresholdBadge`);
                
                if (node.currentMagnitude > THRESHOLD_WARNING) {
                    statusEl.textContent = 'UNSAFE';
                    statusEl.style.color = chartColors.red;
                    badgeEl.textContent = 'Above Unsafe Threshold';
                    badgeEl.className = 'threshold-badge threshold-unsafe';
                } else if (node.currentMagnitude > THRESHOLD_SAFE) {
                    statusEl.textContent = 'WARNING';
                    statusEl.style.color = chartColors.yellow;
                    badgeEl.textContent = 'Warning Threshold';
                    badgeEl.className = 'threshold-badge threshold-warning';
                } else {
                    statusEl.textContent = 'SAFE';
                    statusEl.style.color = chartColors.green;
                    badgeEl.textContent = 'Below Safe Threshold';
                    badgeEl.className = 'threshold-badge threshold-safe';
                }
            }
            
            const totalEvents = nodes.node1.dataPoints + nodes.node2.dataPoints;
            const maxMag = Math.max(nodes.node1.maxMagnitude, nodes.node2.maxMagnitude);
            document.getElementById('statusInfo').textContent = 
                `${totalEvents} Events | Max ${maxMag.toFixed(2)} m/s¬≤`;
        }
        
        function updateCharts() {
            // Implementation would update chart data
            // Simplified for brevity
        }
        
        function addEventToLog(nodeId, magnitude, time) {
            const tbody = document.getElementById('eventTableBody');
            const row = tbody.insertRow(0);
            
            const status = getStatusText(magnitude);
            const statusClass = status === 'SAFE' ? 'status-safe' : 
                              status === 'WARNING' ? 'status-warning' : 'status-unsafe';
            
            row.innerHTML = `
                <td><span class="node-badge ${nodeId}">${nodes[nodeId].name}</span></td>
                <td><span class="mag-badge">${magnitude.toFixed(2)}</span></td>
                <td>${time}</td>
                <td>${nodes[nodeId].location}</td>
                <td><span class="status-badge ${statusClass}">
                    <span class="status-dot"></span>
                    ${status}
                </span></td>
            `;
            
            while (tbody.rows.length > 15) tbody.deleteRow(tbody.rows.length - 1);
        }
        
        function exportToCSV() {
            let csvContent = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            csvContent += 'ERI - MULTI-NODE EARTHQUAKE MONITORING SYSTEM\n';
            csvContent += 'Data Export\n';
            csvContent += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            csvContent += `Export Date: ${new Date().toLocaleString()}\n`;
            csvContent += `Total Events: ${nodes.node1.dataPoints + nodes.node2.dataPoints}\n\n`;
            csvContent += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n';
            
            csvContent += 'Node,Timestamp,X,Y,Z,Magnitude,STA/LTA,Status\n';
            
            Object.values(nodes).forEach(node => {
                node.data.forEach(d => {
                    csvContent += `${node.name},${d.timestamp},${d.x},${d.y},${d.z},${d.magnitude},${d.stalta},${d.status}\n`;
                });
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ERI_MultiNode_${Date.now()}.csv`;
            link.click();
        }
        
        window.addEventListener('load', init);
    </script>
</body>
</html>
